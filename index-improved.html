<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GenSyn AI Discord Leaderboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{
      --bg-primary:#fafafa;
      --bg-secondary:#ffffff;
      --border:#e5e7eb;
      --text-primary:#111827;
      --text-secondary:#6b7280;
      --text-tertiary:#9ca3af;
      --accent:#2563eb;
      --accent-hover:#1d4ed8;
      --accent-light:#eff6ff;
      --success:#10b981;
      --warning:#f59e0b;
      --danger:#ef4444;
      --shadow-sm:0 1px 2px 0 rgba(0,0,0,0.05);
      --shadow:0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px -1px rgba(0,0,0,0.1);
      --shadow-md:0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
      --shadow-lg:0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
      --radius:8px;
      --radius-lg:12px;
    }

    @media (prefers-color-scheme: dark) {
      :root{
        --bg-primary:#0f172a;
        --bg-secondary:#1e293b;
        --border:#334155;
        --text-primary:#f8fafc;
        --text-secondary:#cbd5e1;
        --text-tertiary:#64748b;
      }
    }

    @keyframes fadeIn{
      from{ opacity: 0; transform: translateY(10px) }
      to{ opacity: 1; transform: translateY(0) }
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    *{box-sizing:border-box; margin:0; padding:0}
    html,body{height:100%}
    body{
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:var(--text-primary);
      background:var(--bg-primary);
      min-height:100vh;
      line-height:1.6;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .container{
      max-width:1200px;
      margin:0 auto;
      padding:32px 24px;
    }

    header{
      margin-bottom:32px;
      padding-bottom:24px;
      border-bottom:1px solid var(--border);
    }
    .header-content{
      display:flex;
      align-items:center;
      gap:20px;
      margin-bottom:16px;
    }
    .logo{
      width:56px;
      height:56px;
      border-radius:var(--radius);
      object-fit:cover;
      box-shadow:var(--shadow-sm);
      flex-shrink:0;
      border:1px solid var(--border);
    }
    .header-text{
      flex:1;
    }
    .title{
      font-size:28px;
      font-weight:700;
      letter-spacing:-0.025em;
      color:var(--text-primary);
      margin-bottom:4px;
    }
    .sub{
      color:var(--text-secondary);
      font-size:14px;
      font-weight:500;
    }
    .header-meta{
      display:flex;
      align-items:center;
      gap:16px;
      font-size:13px;
      color:var(--text-tertiary);
    }
    .header-meta-item{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .status-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:var(--success);
      color:white;
      font-size:12px;
      font-weight:600;
    }
    .status-dot{
      width:6px;
      height:6px;
      border-radius:50%;
      background:white;
      animation:pulse 2s ease-in-out infinite;
    }
    @keyframes pulse{
      0%, 100%{ opacity:1 }
      50%{ opacity:0.5 }
    }

    .stats{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));
      gap:20px;
      margin-bottom:32px;
    }
    .stat-card{
      background:var(--bg-secondary);
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      padding:24px;
      transition:all 0.2s ease;
    }
    .stat-card:hover{
      box-shadow:var(--shadow-md);
      border-color:var(--accent);
    }
    .stat-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:16px;
    }
    .stat-label{
      font-size:14px;
      font-weight:600;
      color:var(--text-secondary);
      text-transform:uppercase;
      letter-spacing:0.05em;
    }
    .stat-icon{
      width:40px;
      height:40px;
      border-radius:var(--radius);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
      background:var(--accent-light);
      color:var(--accent);
    }
    .stat-value{
      font-size:36px;
      font-weight:700;
      color:var(--text-primary);
      line-height:1;
      letter-spacing:-0.02em;
    }
    .stat-change{
      display:flex;
      align-items:center;
      gap:4px;
      margin-top:8px;
      font-size:13px;
      font-weight:500;
      color:var(--success);
    }
    .stat-change.negative{
      color:var(--danger);
    }

    .controls{
      display:flex;
      align-items:center;
      gap:16px;
      margin-bottom:24px;
      flex-wrap:wrap;
    }

    .selector-wrap{
      flex:1;
      min-width:250px;
    }
    .selector-label{
      display:block;
      font-size:13px;
      font-weight:600;
      color:var(--text-secondary);
      margin-bottom:8px;
    }
    .csv-selector{
      width:100%;
      padding:10px 40px 10px 14px;
      border-radius:var(--radius);
      border:1px solid var(--border);
      background:var(--bg-secondary);
      color:var(--text-primary);
      font-size:14px;
      font-weight:500;
      cursor:pointer;
      transition:all 0.2s;
      appearance:none;
      background-image:url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M5 7.5L10 12.5L15 7.5' stroke='%236b7280' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat:no-repeat;
      background-position:right 12px center;
    }
    .csv-selector:hover{
      border-color:var(--accent);
    }
    .csv-selector:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 3px var(--accent-light);
    }

    .search-wrap{
      position:relative;
      flex:1;
      min-width:250px;
    }
    .search-input{
      width:100%;
      padding:10px 14px 10px 40px;
      border-radius:var(--radius);
      border:1px solid var(--border);
      background:var(--bg-secondary);
      color:var(--text-primary);
      font-size:14px;
      transition:all 0.2s;
    }
    .search-input:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 3px var(--accent-light);
    }
    .search-input::placeholder{
      color:var(--text-tertiary);
    }
    .search-icon{
      position:absolute;
      left:12px;
      top:50%;
      transform:translateY(-50%);
      color:var(--text-tertiary);
      width:18px;
      height:18px;
      pointer-events:none;
    }
    .clear-btn{
      position:absolute;
      right:8px;
      top:50%;
      transform:translateY(-50%);
      border:none;
      background:var(--bg-primary);
      color:var(--text-secondary);
      padding:4px 10px;
      border-radius:var(--radius);
      cursor:pointer;
      font-size:12px;
      font-weight:600;
      display:none;
      transition:all 0.2s;
    }
    .clear-btn:hover{
      background:var(--border);
    }

    .leaderboard{
      margin-top:32px;
    }

    .lb-card{
      background:var(--bg-secondary);
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      overflow:hidden;
    }
    .lb-head{
      padding:20px 24px;
      border-bottom:1px solid var(--border);
      background:var(--bg-secondary);
    }
    .lb-title{
      font-size:18px;
      font-weight:700;
      color:var(--text-primary);
    }

    .helper{
      padding:12px 24px;
      font-size:13px;
      color:var(--text-secondary);
      background:var(--bg-primary);
      border-bottom:1px solid var(--border);
    }

    .table-wrap{
      width:100%;
      overflow-x:auto;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
    }
    thead th{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.05em;
      color:var(--text-secondary);
      text-align:left;
      background:var(--bg-primary);
      position:sticky;
      top:0;
      z-index:10;
      padding:16px 24px;
      font-weight:700;
      border-bottom:2px solid var(--border);
    }
    tbody td{
      padding:16px 24px;
      border-bottom:1px solid var(--border);
      font-size:14px;
      color:var(--text-primary);
    }
    tbody tr{
      transition:background 0.15s ease;
      background:var(--bg-secondary);
    }
    tbody tr:hover{
      background:var(--accent-light);
    }
    tbody tr:last-child td{
      border-bottom:none;
    }

    .rank-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:36px;
      height:36px;
      padding:0 12px;
      border-radius:var(--radius);
      font-weight:700;
      font-size:14px;
      color:var(--text-primary);
      background:var(--bg-primary);
      border:2px solid var(--border);
    }
    .gold{
      background:#fef3c7;
      border-color:#fbbf24;
      color:#92400e;
    }
    .silver{
      background:#f3f4f6;
      border-color:#9ca3af;
      color:#374151;
    }
    .bronze{
      background:#fed7aa;
      border-color:#fb923c;
      color:#7c2d12;
    }

    .level{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 12px;
      border-radius:var(--radius);
      font-weight:600;
      font-size:13px;
      border:1px solid;
      transition:all 0.15s ease;
    }
    .lvl-1{
      background:#f3f4f6;
      border-color:#d1d5db;
      color:#374151;
    }
    .lvl-2{
      background:#dbeafe;
      border-color:#93c5fd;
      color:#1e40af;
    }
    .lvl-3{
      background:#e0e7ff;
      border-color:#a5b4fc;
      color:#4338ca;
    }
    .lvl-4{
      background:#fef3c7;
      border-color:#fbbf24;
      color:#92400e;
    }
    .lvl-5{
      background:#fee2e2;
      border-color:#fca5a5;
      color:#991b1b;
    }
    .lvl-6{
      background:linear-gradient(135deg, #fef3c7, #fed7aa);
      border-color:#f59e0b;
      color:#92400e;
    }

    mark{
      background:#fef3c7;
      color:inherit;
      padding:2px 4px;
      border-radius:4px;
      font-weight:600;
    }

    .pagination{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:20px 24px;
      background:var(--bg-secondary);
      border-top:1px solid var(--border);
    }
    .page-btn{
      min-width:36px;
      height:36px;
      padding:0 12px;
      border:1px solid var(--border);
      background:var(--bg-secondary);
      color:var(--text-primary);
      border-radius:var(--radius);
      cursor:pointer;
      font-weight:600;
      font-size:14px;
      transition:all 0.15s ease;
    }
    .page-btn:hover:not([disabled]){
      background:var(--accent-light);
      border-color:var(--accent);
      color:var(--accent);
    }
    .page-btn[disabled]{
      opacity:0.4;
      cursor:not-allowed;
    }
    .page-btn.active{
      background:var(--accent);
      border-color:var(--accent);
      color:white;
    }

    .not-found{
      padding:48px 24px;
      text-align:center;
      color:var(--text-tertiary);
      font-size:14px;
    }


    .loading{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:48px 24px;
      font-size:14px;
      color:var(--text-secondary);
    }
    .dot{
      width:8px;
      height:8px;
      border-radius:50%;
      background:var(--accent);
      animation:bounce 1s infinite alternate;
    }
    .dot:nth-child(2){animation-delay:0.2s}
    .dot:nth-child(3){animation-delay:0.4s}
    @keyframes bounce{
      to{transform:translateY(-8px)}
    }

    .fallback{
      display:none;
      gap:12px;
      align-items:center;
      padding:20px 24px;
      background:var(--bg-secondary);
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      margin-top:16px;
    }
    .fallback button{
      padding:10px 16px;
      border:1px solid var(--accent);
      background:var(--accent);
      color:white;
      border-radius:var(--radius);
      cursor:pointer;
      font-weight:600;
      font-size:14px;
      transition:all 0.2s;
    }
    .fallback button:hover{
      background:var(--accent-hover);
      border-color:var(--accent-hover);
    }
    .fallback .msg{
      color:var(--text-secondary);
      font-size:14px;
    }

    /* Chart & legend styles */
    .chart-card{
      background:var(--bg-secondary);
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      overflow:hidden;
      margin-bottom:32px;
    }
    .chart-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:20px 24px;
      border-bottom:1px solid var(--border);
    }
    .chart-title{
      font-weight:700;
      font-size:18px;
      color:var(--text-primary);
    }
    .seg{
      display:inline-flex;
      gap:4px;
      padding:4px;
      background:var(--bg-primary);
      border-radius:var(--radius);
    }
    .seg-btn{
      padding:6px 14px;
      border:none;
      background:transparent;
      color:var(--text-secondary);
      border-radius:calc(var(--radius) - 2px);
      cursor:pointer;
      font-weight:600;
      font-size:13px;
      transition:all 0.2s;
    }
    .seg-btn:hover{
      color:var(--text-primary);
    }
    .seg-btn.active{
      background:var(--bg-secondary);
      color:var(--accent);
      box-shadow:var(--shadow-sm);
    }
    .chart{
      padding:20px 24px;
    }
    .chart-row{
      display:flex;
      align-items:center;
      gap:16px;
      padding:12px 0;
    }
    .chart-label{
      min-width:140px;
      font-weight:600;
      font-size:13px;
      color:var(--text-primary);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .chart-label-icon{
      width:12px;
      height:12px;
      border-radius:4px;
      display:inline-block;
    }
    .chart-label-icon.lvl-1{background:#9ca3af}
    .chart-label-icon.lvl-2{background:#60a5fa}
    .chart-label-icon.lvl-3{background:#a78bfa}
    .chart-label-icon.lvl-4{background:#f59e0b}
    .chart-label-icon.lvl-5{background:#f87171}
    .chart-label-icon.lvl-6{background:#fbbf24}
    .bar-wrap{
      flex:1;
      height:24px;
      background:var(--bg-primary);
      border-radius:var(--radius);
      position:relative;
      overflow:hidden;
    }
    .bar{
      height:100%;
      border-radius:var(--radius);
      transition:width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .bar.lvl-1{background:#9ca3af}
    .bar.lvl-2{background:#60a5fa}
    .bar.lvl-3{background:#a78bfa}
    .bar.lvl-4{background:#f59e0b}
    .bar.lvl-5{background:#f87171}
    .bar.lvl-6{background:#fbbf24}
    .bar-count{
      min-width:100px;
      text-align:right;
      font-variant-numeric:tabular-nums;
      font-size:14px;
      font-weight:700;
      color:var(--text-primary);
      display:flex;
      justify-content:flex-end;
      align-items:baseline;
      gap:4px;
    }
    .bar-pct{
      font-size:13px;
      color:var(--text-secondary);
      font-weight:500;
    }
    .chart-foot{
      padding:12px 24px;
      color:var(--text-secondary);
      font-size:13px;
      background:var(--bg-primary);
      border-top:1px solid var(--border);
    }

    .legend{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));
      gap:12px;
      padding:20px 24px;
      background:var(--bg-primary);
      border-top:1px solid var(--border);
    }
    .legend-item{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:13px;
      color:var(--text-primary);
      font-weight:500;
    }
    .legend-dot{
      width:12px;
      height:12px;
      border-radius:4px;
      display:inline-block;
    }
    .legend-dot.lvl-1{background:#9ca3af}
    .legend-dot.lvl-2{background:#60a5fa}
    .legend-dot.lvl-3{background:#a78bfa}
    .legend-dot.lvl-4{background:#f59e0b}
    .legend-dot.lvl-5{background:#f87171}
    .legend-dot.lvl-6{background:#fbbf24}

    footer{
      text-align:center;
      padding:32px 24px;
      margin-top:48px;
      border-top:1px solid var(--border);
    }
    footer p{
      font-size:14px;
      color:var(--text-secondary);
    }
    footer a{
      color:var(--accent);
      text-decoration:none;
      font-weight:600;
      transition:color 0.2s;
    }
    footer a:hover{
      color:var(--accent-hover);
      text-decoration:underline;
    }

    /* Responsive */
    @media (max-width: 768px){
      .container{
        padding:20px 16px;
      }
      .header-content{
        flex-direction:column;
        align-items:flex-start;
      }
      .header-meta{
        flex-wrap:wrap;
      }
      .stats{
        grid-template-columns:1fr;
      }
      .controls{
        flex-direction:column;
      }
      .selector-wrap,
      .search-wrap{
        width:100%;
      }
      thead th,
      tbody td{
        padding:12px 16px;
      }
      .chart-label{
        min-width:100px;
        font-size:12px;
      }
      .bar-count{
        min-width:80px;
        font-size:13px;
      }
      .legend{
        grid-template-columns:1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-content">
        <img src="gensynai_logo.jpg" alt="GenSyn AI" class="logo">
        <div class="header-text">
          <div class="title">GenSyn AI Leaderboard</div>
          <div class="sub">Discord Community Analytics Dashboard</div>
        </div>
        <div class="status-badge">
          <span class="status-dot"></span>
          Live Data
        </div>
      </div>
      <div class="header-meta">
        <div class="header-meta-item">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
            <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
          </svg>
          <span>Snapshot: Nov 6, 2025</span>
        </div>
      </div>
    </header>

    <div class="controls">
      <div class="selector-wrap">
        <label class="selector-label" for="csvSelector">Channel/Country</label>
        <select id="csvSelector" class="csv-selector" aria-label="Select CSV data source">
        <option value="usernames-with-total-message-counts.csv">üí¨ General Chat</option>
        <option value="india_message_counts.csv">üáÆüá≥ India</option>
        <option value="china_message_counts.csv">üá®üá≥ China</option>
        <option value="indonesia_message_counts.csv">üáÆüá© Indonesia</option>
        <option value="russia_message_counts.csv">üá∑üá∫ Russia</option>
        <option value="ukraine_message_counts.csv">üá∫üá¶ Ukraine</option>
        <option value="vietnam_message_counts.csv">üáªüá≥ Vietnam</option>
        <option value="korea_message_counts.csv">üá∞üá∑ Korea</option>
        <option value="turkey_message_counts.csv">üáπüá∑ Turkey</option>
        <option value="nigeria_message_counts.csv">üá≥üá¨ Nigeria</option>
        <option value="blockassist_support_message_counts.csv">ü§ñ BlockAssist Support</option>
        <option value="codeassist_support_message_counts.csv">üíæ CodeAssist Support</option>
        <option value="rlswarm_support.csv">üêù RLSwarm Support</option>
      </select>
      </div>
      <div class="search-wrap">
        <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="M21 21l-4.35-4.35"/>
        </svg>
        <input id="search" class="search-input" placeholder="Search username..." autocomplete="off" aria-label="Search usernames" />
        <button id="clearSearch" class="clear-btn" aria-label="Clear search">Clear</button>
      </div>
    </div>

    <section class="stats">
      <div class="stat-card">
        <div class="stat-header">
          <div class="stat-label">Total Users</div>
          <div class="stat-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
          </div>
        </div>
        <div class="stat-value" id="statUsers">‚Äî</div>
      </div>
      <div class="stat-card">
        <div class="stat-header">
          <div class="stat-label">Total Messages</div>
          <div class="stat-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
          </div>
        </div>
        <div class="stat-value" id="statMessages">‚Äî</div>
      </div>
      <div class="stat-card">
        <div class="stat-header">
          <div class="stat-label">Top Score</div>
          <div class="stat-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
          </div>
        </div>
        <div class="stat-value" id="statTop">‚Äî</div>
      </div>
    </section>

    <!-- Level Distribution Chart -->
    <section class="chart-card" aria-labelledby="chartTitle">
      <div class="chart-head">
        <div class="chart-title" id="chartTitle">Level Distribution</div>
        <div class="seg" role="tablist" aria-label="Chart scope">
          <button class="seg-btn active" data-scope="all" role="tab" aria-selected="true">All Users</button>
          <button class="seg-btn" data-scope="top100" role="tab" aria-selected="false">Top 100</button>
        </div>
      </div>
      <div id="chart" class="chart" aria-live="polite"></div>
      <div class="legend" id="levelLegend" aria-describedby="chartTitle"></div>
      <div class="chart-foot" id="chartFoot"></div>
    </section>

    <section class="leaderboard">
      <div class="lb-card">
        <div class="lb-head">
          <div class="lb-title">Leaderboard Rankings</div>
        </div>
        <div class="helper" id="helperText">Showing top 100 users ‚Ä¢ 10 per page</div>
        <div class="table-wrap">
          <table aria-label="Leaderboard">
            <thead>
              <tr>
                <th style="width:110px">Rank</th>
                <th>Username</th>
                <th style="width:180px">Message Count</th>
                <th style="width:160px">Level Badge</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td colspan="4"><div class="loading"><span class="dot"></span><span class="dot"></span><span class="dot"></span> Loading CSV‚Ä¶</div></td></tr>
            </tbody>
          </table>
        </div>
        <div class="pagination" id="pagination" aria-label="Pagination"></div>
      </div>

      <div class="fallback" id="fallback">
        <span class="msg">Couldn't auto-load the selected CSV file. You can load it manually:</span>
        <button id="pickFile">Choose CSV</button>
        <input id="fileInput" type="file" accept=".csv" hidden />
      </div>
    </section>
  </div>

  <script>
    const state = {
      usersAll: [],
      usersTop100: [],
      currentPage: 1,
      rowsPerPage: 10,
      searchActive: false,
      searchQuery: '',
      chartScope: 'all',
    };

    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);

    const tbody = $('#tbody');
    const pagination = $('#pagination');
    const helperText = $('#helperText');
    const statUsers = $('#statUsers');
    const statMessages = $('#statMessages');
    const statTop = $('#statTop');
    const searchInput = $('#search');
    const clearBtn = $('#clearSearch');
    const fallback = $('#fallback');
    const fileInput = $('#fileInput');
    const pickFileBtn = $('#pickFile');
    const chartEl = $('#chart');
    const chartFoot = $('#chartFoot');
    const legendEl = $('#levelLegend');
    const csvSelector = $('#csvSelector');

    // Canonical level meta (used for labels/legend)
    const LEVELS_META = [
      { lvl:1, cls:'lvl-1', name:'Level 1', range:'0‚Äì100' },
      { lvl:2, cls:'lvl-2', name:'Level 2', range:'101‚Äì500' },
      { lvl:3, cls:'lvl-3', name:'Level 3', range:'501‚Äì1,000' },
      { lvl:4, cls:'lvl-4', name:'Level 4', range:'1,001‚Äì5,000' },
      { lvl:5, cls:'lvl-5', name:'Level 5', range:'5,001‚Äì9,999' },
      { lvl:6, cls:'lvl-6', name:'Level 6', range:'10,000+' },
    ];

    function formatNumber(n){
      return new Intl.NumberFormat(undefined).format(n);
    }

    function getLevel(count){
      if (count >= 10000) return { lvl: 6, cls: 'lvl-6', name: 'Level 6' };
      if (count >= 5001) return { lvl: 5, cls: 'lvl-5', name: 'Level 5' };
      if (count >= 1001) return { lvl: 4, cls: 'lvl-4', name: 'Level 4' };
      if (count >= 501)  return { lvl: 3, cls: 'lvl-3', name: 'Level 3' };
      if (count >= 101)  return { lvl: 2, cls: 'lvl-2', name: 'Level 2' };
      return { lvl: 1, cls: 'lvl-1', name: 'Level 1' };
    }

    // FIX: ensure no stray parenthesis here
    function escapeHTML(str){
      return String(str).replace(/[&<>"']/g, (s) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        "\"": "&quot;",
        "'": "&#39;"
      })[s]);
    }

    function highlight(text, query){
      if (!query) return escapeHTML(text);
      const safe = escapeHTML(text);
      const q = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      return safe.replace(new RegExp(q, 'gi'), m => `<mark>${m}</mark>`);
    }

    function rankBadge(rank){
      let cls = 'rank-badge';
      if (rank === 1) cls += ' gold';
      else if (rank === 2) cls += ' silver';
      else if (rank === 3) cls += ' bronze';
      return `<span class="${cls}" aria-label="Rank ${rank}">#${rank}</span>`;
    }

    function animateValue(el, end){
      const start = 0;
      const duration = 1000;
      const startTime = performance.now();
      const animate = (currentTime) => {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const easeOut = 1 - Math.pow(1 - progress, 3);
        const current = Math.floor(start + (end - start) * easeOut);
        el.textContent = formatNumber(current);
        if (progress < 1) requestAnimationFrame(animate);
      };
      requestAnimationFrame(animate);
    }

    function renderStats(){
      const all = state.usersAll;
      const totalUsers = all.length;
      const totalMessages = all.reduce((s,u)=> s + u.message_count, 0);
      const topScore = all[0] ? all[0].message_count : 0;
      animateValue(statUsers, totalUsers);
      animateValue(statMessages, totalMessages);
      animateValue(statTop, topScore);
    }

    function renderTable(rows){
      if (!rows.length){
        tbody.innerHTML = `<tr><td colspan="4"><div class="not-found">Not found</div></td></tr>`;
        return;
      }
      const html = rows.map(user => {
        const level = getLevel(user.message_count);
        const rangeText = LEVELS_META[level.lvl-1].range;
        return `<tr>
          <td>${rankBadge(user.rank)}</td>
          <td><span class="uname">${state.searchActive ? highlight(user.username, state.searchQuery) : escapeHTML(user.username)}</span></td>
          <td><strong>${formatNumber(user.message_count)}</strong></td>
          <td><span class="level ${level.cls}" title="${level.name}: ${rangeText} messages">${level.name}</span></td>
        </tr>`;
      }).join('');
      tbody.innerHTML = html;
    }

    function renderPagination(){
      if (state.searchActive){
        pagination.innerHTML = '';
        return;
      }
      const total = state.usersTop100.length;
      const pages = Math.max(1, Math.ceil(total / state.rowsPerPage));
      const parts = [];
      const btn = (label, opts={}) => {
        const disabled = opts.disabled ? 'disabled' : '';
        const active = opts.active ? 'active' : '';
        return `<button class="page-btn ${active}" ${disabled} data-page="${opts.page ?? ''}">${label}</button>`;
      };
      parts.push(btn('Prev', { disabled: state.currentPage === 1, page: state.currentPage - 1 }));
      for (let p=1; p<=pages; p++) parts.push(btn(p, { page: p, active: p === state.currentPage }));
      parts.push(btn('Next', { disabled: state.currentPage === pages, page: state.currentPage + 1 }));
      pagination.innerHTML = parts.join('');

      pagination.querySelectorAll('.page-btn').forEach(el => {
        const page = Number(el.dataset.page);
        el.addEventListener('click', () => {
          if (!page || el.hasAttribute('disabled')) return;
          state.currentPage = page;
          updateView();
        });
      });
    }

    function updateView(){
      if (state.searchActive){
        const q = state.searchQuery.trim().toLowerCase();
        const results = state.usersAll.filter(u => u.username.toLowerCase().includes(q));
        helperText.textContent = results.length ? `Search results for "${state.searchQuery}" ‚Ä¢ ${results.length} match${results.length!==1?'es':''}` : `No matches for "${state.searchQuery}"`;
        renderTable(results.slice(0, 100)); // Limit search results to 100
        renderPagination();
      } else {
        helperText.textContent = 'Showing top 100 users ‚Ä¢ 10 per page';
        const start = (state.currentPage - 1) * state.rowsPerPage;
        const pageRows = state.usersTop100.slice(start, start + state.rowsPerPage);
        renderTable(pageRows);
        renderPagination();
      }
    }

    function normalizeRow(row){
      const username = row.username ?? row.User ?? row.Username ?? row["user name"] ?? row["User Name"]; 
      const mcRaw = row.message_count ?? row["message_count"] ?? row["Message Count"] ?? row["messages"] ?? row["total_messages"]; 
      const message_count = Number(String(mcRaw ?? '').replace(/[\,\s]/g, ''));
      if (!username || !Number.isFinite(message_count)) return null;
      return { username: String(username).trim(), message_count };
    }

    function ingestData(rows){
      const users = rows.map(normalizeRow).filter(Boolean);
      users.sort((a,b)=> b.message_count - a.message_count || a.username.localeCompare(b.username));
      users.forEach((u,i)=> u.rank = i + 1);
      state.usersAll = users;
      state.usersTop100 = users.slice(0, 100);
      state.currentPage = 1; state.searchActive = false; state.searchQuery = '';
      renderStats();
      updateView();
      renderLevelChart(state.chartScope);
    }

    function loadCSVFromURL(filename = 'usernames-with-total-message-counts.csv'){
      return new Promise((resolve, reject) => {
        Papa.parse(filename, {
          download: true,
          header: true,
          skipEmptyLines: true,
          complete: (results) => {
            if (results && results.data && results.data.length){ resolve(results.data); }
            else reject(new Error('CSV parsed but empty'));
          },
          error: (err) => reject(err)
        });
      });
    }

    async function loadSelectedCSV(){
      const selectedFile = csvSelector.value;
      tbody.innerHTML = '<tr><td colspan="4"><div class="loading"><span class="dot"></span><span class="dot"></span><span class="dot"></span> Loading CSV‚Ä¶</div></td></tr>';
      fallback.style.display = 'none';
      
      // Disable selector while loading to prevent multiple loads
      csvSelector.disabled = true;
      
      try {
        const rows = await loadCSVFromURL(selectedFile);
        ingestData(rows);
      } catch (e){
        console.error('Error loading CSV:', e);
        tbody.innerHTML = `<tr><td colspan="4"><div class="not-found">Couldn't load ${selectedFile}. Make sure the file exists.</div></td></tr>`;
        showFallback();
      } finally {
        csvSelector.disabled = false;
      }
    }

    function showFallback(){
      fallback.style.display = 'flex';
    }

    function debounce(fn, ms){
      let t; return (...args) => { clearTimeout(t); t = setTimeout(()=>fn.apply(null,args), ms); };
    }

    // ===== Chart & legend logic =====
    function computeLevelBuckets(list){
      const buckets = [0,0,0,0,0,0]; // index 0->L1 ‚Ä¶ 5->L6
      for (const u of list){
        const lvl = getLevel(u.message_count).lvl; // 1..6
        buckets[lvl-1]++;
      }
      return buckets;
    }

    function renderLegend(){
      const items = LEVELS_META.map(m => (
        `<div class="legend-item"><span class="legend-dot ${m.cls}"></span><span>${m.name} ‚Äî ${m.range} messages</span></div>`
      )).join('');
      legendEl.innerHTML = items;
    }

    function renderLevelChart(scope='all'){
      const list = scope === 'top100' ? state.usersTop100 : state.usersAll;
      const buckets = computeLevelBuckets(list);
      const total = list.length;
      const MIN_BAR_PCT = 0.5; // visual floor so tiny non-zero buckets still show color
      const labels = LEVELS_META.map(m => `${m.name} (${m.range})`);
      const rows = buckets.map((count, idx) => {
        const userPctRaw = total > 0 ? (count / total) * 100 : 0;
        const userPct = userPctRaw < 0.1 && userPctRaw > 0 ? userPctRaw.toFixed(4) : userPctRaw.toFixed(1);
        const pct = count > 0 ? Math.max(userPctRaw, MIN_BAR_PCT) : 0; // Use actual percentage for bar width
        const cls = `lvl-${idx+1}`;
        const meta = LEVELS_META[idx];
        const aria = `${labels[idx]}: ${formatNumber(count)} users (${userPct}%)`;
        return `<div class="chart-row">
          <div class="chart-label">
            <span class="chart-label-icon ${meta.cls}"></span>
            <span>${meta.name}</span>
          </div>
          <div class="bar-wrap" aria-hidden="true" title="${labels[idx]}: ${formatNumber(count)} users">
            <div class="bar ${cls}" style="width:${pct}%"></div>
          </div>
          <div class="bar-count" aria-label="${aria}">
            ${formatNumber(count)}
            <span class="bar-pct">(${userPct}%)</span>
          </div>
        </div>`;
      }).join('');
      chartEl.innerHTML = rows;
      chartFoot.innerHTML = `<strong>${scope==='top100' ? 'Top 100' : 'All users'}</strong> ‚Ä¢ ${formatNumber(list.length)} total users`;
      $$('.seg-btn').forEach(btn => {
        const active = btn.dataset.scope === scope;
        btn.classList.toggle('active', active);
        btn.setAttribute('aria-selected', String(active));
      });
    }

    // ==== Lightweight Test Harness (runs in console) ====
    function runTests(){
      const results = [];
      const assert = (name, cond) => { results.push({ name, pass: !!cond }); if(!cond) console.error(`‚ùå ${name}`); };
      const eq = (a,b) => a===b;

      // escapeHTML tests
      assert('escapeHTML encodes &', eq(escapeHTML('&'), '&amp;'));
      assert('escapeHTML encodes <', eq(escapeHTML('<'), '&lt;'));
      assert('escapeHTML encodes >', eq(escapeHTML('>'), '&gt;'));
      assert('escapeHTML encodes "', eq(escapeHTML('"'), '&quot;'));
      assert("escapeHTML encodes '", eq(escapeHTML("'"), '&#39;'));
      assert('escapeHTML mixed', eq(escapeHTML('A&B<C>"\''), 'A&amp;B&lt;C&gt;&quot;&#39;'));

      // getLevel boundary tests
      const L = (n)=>getLevel(n).lvl;
      assert('Level 1 at 0', eq(L(0),1));
      assert('Level 1 at 100', eq(L(100),1));
      assert('Level 2 at 101', eq(L(101),2));
      assert('Level 2 at 500', eq(L(500),2));
      assert('Level 3 at 501', eq(L(501),3));
      assert('Level 3 at 1000', eq(L(1000),3));
      assert('Level 4 at 1001', eq(L(1001),4));
      assert('Level 4 at 5000', eq(L(5000),4));
      assert('Level 5 at 5001', eq(L(5001),5));
      assert('Level 5 at 9999', eq(L(9999),5));
      assert('Level 6 at 10000', eq(L(10000),6));
      assert('Level 6 above 10000', eq(L(12000),6));

      // legend/meta tests
      assert('LEVELS_META length 6', LEVELS_META.length===6);
      assert('L5 range 5,001‚Äì9,999', LEVELS_META[4].range==='5,001‚Äì9,999');
      assert('L6 range 10,000+', LEVELS_META[5].range==='10,000+');

      // normalizeRow tests
      const nr = normalizeRow({ username:'alice', message_count:'1,234' });
      assert('normalizeRow parses commas', nr && nr.username==='alice' && nr.message_count===1234);
      const nr2 = normalizeRow({ User:'Bob', messages:'42' });
      assert('normalizeRow header variants', nr2 && nr2.username==='Bob' && nr2.message_count===42);

      // highlight test (regex escaping)
      const h = highlight('user.[name]', '.[');
      assert('highlight escapes regex', h.includes('<mark>'));

      // computeLevelBuckets tests
      const sample = [0,100,101,500,501,1000,1001,5000,5001,9999,10000].map(n=>({username:'u'+n, message_count:n}));
      const b = computeLevelBuckets(sample);
      assert('Buckets length 6', b.length===6);
      assert('Bucket L1 count', b[0]===2);
      assert('Bucket L2 count', b[1]===2);
      assert('Bucket L3 count', b[2]===2);
      assert('Bucket L4 count', b[3]===2);
      assert('Bucket L5 count', b[4]===2);
      assert('Bucket L6 count', b[5]===1);
      assert('Bucket sum equals list length', b.reduce((a,c)=>a+c,0)===sample.length);

      console.log(`\n‚Äî‚Äî Test Summary ‚Äî‚Äî`);
      const passed = results.filter(r=>r.pass).length;
      console.log(`Passed ${passed}/${results.length} checks`);
      window.__leaderboardTests = results;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Load initial CSV
      await loadSelectedCSV();

      renderLegend();

      try { runTests(); } catch (e) { console.warn('Tests failed to run:', e); }

      // Add event listener for CSV selector
      csvSelector.addEventListener('change', loadSelectedCSV);

      const onSearch = debounce(() => {
        const q = searchInput.value || '';
        state.searchQuery = q;
        state.searchActive = q.trim().length > 0;
        clearBtn.style.display = state.searchActive ? 'inline-block' : 'none';
        updateView();
      }, 300);

      searchInput.addEventListener('input', onSearch);
      clearBtn.addEventListener('click', () => { searchInput.value = ''; onSearch(); searchInput.focus(); });

      pickFileBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        Papa.parse(file, {
          header:true,
          skipEmptyLines:true,
          complete: (results) => { ingestData(results.data); fallback.style.display = 'none'; },
          error: () => { alert('Failed to parse the selected CSV.'); }
        });
      });

      searchInput.addEventListener('keydown', (e) => { if (e.key === 'Escape'){ clearBtn.click(); } });

      $$('.seg-btn').forEach(btn => {
        btn.addEventListener('click', () => { state.chartScope = btn.dataset.scope; renderLevelChart(state.chartScope); });
      });
    });
  </script>

  <footer>
    <p>Made with precision by <a href="https://twitter.com/Abbymaxpain" target="_blank" rel="noopener">@Abbymaxpain</a></p>
  </footer>
</body>
</html>
