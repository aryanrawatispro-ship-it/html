<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GenSyn AI Discord Leaderboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{
      --bg-1:#ffe1e8; /* pink */
      --bg-2:#ffd7ba; /* peach */
      --bg-3:#fff3d6; /* soft yellow */
      --card:#ffffff;
      --text:#0f172a;
      --muted:#6b7280;
      --accent:#f97316; /* orange */
      --ring:#fb923c;
      --shadow:0 10px 25px rgba(15, 23, 42, 0.08);
      --radius:14px;
      --radius-sm:10px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text);
      background: radial-gradient(1200px 800px at 10% 0%, var(--bg-1), transparent 60%),
                  radial-gradient(1200px 800px at 90% 10%, var(--bg-2), transparent 60%),
                  linear-gradient(180deg, var(--bg-3), #fff);
      min-height:100%;
    }
    .container{max-width:900px; margin:24px auto; padding:0 16px}

    header{margin-bottom:12px; display:flex; align-items:center; gap:12px}
    .logo{width:40px; height:40px; border-radius:10px; object-fit:cover; box-shadow:var(--shadow); flex-shrink:0}
    .title{font-size: clamp(18px, 2vw, 22px); font-weight:800; letter-spacing:-0.02em}
    .sub{color:var(--muted); font-size:12px; margin-top:2px}

    .stats{display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin:12px 0 14px}
    .card{background:var(--card); border-radius:var(--radius-sm); box-shadow:var(--shadow); padding:12px 14px}
    .stat .label{color:var(--muted); font-size:10px; text-transform:uppercase; letter-spacing:.08em}
    .stat .value{font-size: clamp(18px, 3.5vw, 24px); font-weight:800; margin-top:4px; color:#111827; transition:transform .3s}
    .stat:hover .value{transform:scale(1.05)}

    .actions{display:flex; align-items:center; gap:10px; margin-top:10px}

    .search-wrap{position:relative; flex:1; max-width:320px}
    .search-input{
      width:100%; padding:10px 38px; border-radius:999px; border:1px solid #f3f4f6; background:#fff;
      box-shadow:var(--shadow); outline:none; transition: box-shadow .2s, border-color .2s; font-size:13px
    }
    .search-input:focus{border-color:var(--ring); box-shadow:0 0 0 3px rgba(251,146,60,.18), var(--shadow)}
    .search-icon{position:absolute; left:12px; top:50%; transform:translateY(-50%); opacity:.6; width:16px; height:16px}
    .clear-btn{position:absolute; right:6px; top:50%; transform:translateY(-50%); border:none; background:#f3f4f6; color:#6b7280; padding:4px 8px; border-radius:999px; cursor:pointer; font-size:11px; display:none; transition:all .2s}
    .clear-btn:hover{background:#e5e7eb; transform:translateY(-50%) scale(1.05)}
    .clear-btn:active{transform:translateY(-50%) scale(0.98)}

    .leaderboard{margin-top:10px}

    .lb-card{background:var(--card); border-radius:var(--radius-sm); box-shadow:var(--shadow); overflow:hidden}
    .lb-head{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 14px; border-bottom:1px solid #f3f4f6}
    .lb-title{font-weight:700; font-size:14px; white-space:nowrap}

    .table-wrap{width:100%; overflow:auto}
    table{width:100%; border-collapse:separate; border-spacing:0}
    thead th{font-size:10px; text-transform:uppercase; letter-spacing:.08em; color:var(--muted); text-align:left; background:#fff; position:sticky; top:0; z-index:1; padding:10px 12px; border-bottom:1px solid #f3f4f6}
    tbody td{padding:10px 12px; border-bottom:1px solid #f3f4f6; font-size:13px}
    tbody tr{transition: background .15s; cursor:pointer}
    tbody tr:hover{background:#fff7ed}

    .rank-badge{display:inline-flex; align-items:center; justify-content:center; min-width:28px; padding:3px 8px; border-radius:999px; font-weight:700; font-size:11px; color:#111827; background:#e5e7eb; box-shadow:inset 0 0 0 1px rgba(0,0,0,.04)}
    .gold{background:linear-gradient(135deg,#ffd700,#ffb200); color:#6b4000}
    .silver{background:linear-gradient(135deg,#c0c0c0,#9ea7b8); color:#243041}
    .bronze{background:linear-gradient(135deg,#cd7f32,#b87333); color:#3e1d00}

    .level{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-weight:700; font-size:11px; color:#fff; box-shadow:var(--shadow); transition:transform .2s}
    .level:hover{transform:scale(1.08)}
    .lvl-1{background:#9ca3af}
    .lvl-2{background:#60a5fa}
    .lvl-3{background:#a78bfa}
    .lvl-4{background:#f59e0b}
    .lvl-5{background:#f87171}
    .lvl-6{background:#fbbf24; color:#6b4000}

    mark{background:#ffe8c7; color:inherit; padding:0 .15em; border-radius:4px}

    .pagination{display:flex; align-items:center; justify-content:center; gap:4px; padding:12px}
    .page-btn{border:none; background:#fff; padding:6px 10px; border-radius:8px; box-shadow:var(--shadow); cursor:pointer; font-weight:600; font-size:12px; transition: transform .12s, background .12s, box-shadow .12s}
    .page-btn:hover:not([disabled]){transform:translateY(-1px); background:#fff7ed; box-shadow:0 8px 20px rgba(15, 23, 42, 0.1)}
    .page-btn:active:not([disabled]){transform:translateY(0); box-shadow:var(--shadow)}
    .page-btn[disabled]{opacity:.5; cursor:not-allowed; transform:none}
    .page-btn.active{background:#ffedd5; box-shadow:0 0 0 2px #fb923c}

    .helper{font-size:11px; color:var(--muted); padding:8px 14px; border-bottom:1px solid #f3f4f6}
    .not-found{padding:20px; text-align:center; color:#9ca3af; font-size:13px}

    .selector-wrap{margin:14px 0; display:flex; align-items:center; gap:10px; position:relative}
    .selector-label{font-size:11px; font-weight:700; color:var(--accent); white-space:nowrap; text-transform:uppercase; letter-spacing:.1em}
    .csv-selector{
      flex:1; max-width:320px; padding:11px 16px; border-radius:12px; border:2px solid transparent; 
      background:linear-gradient(135deg, #fff7ed, #fff); box-shadow:0 4px 12px rgba(249, 115, 22, 0.15), inset 0 1px 0 rgba(255,255,255,.8); 
      outline:none; transition: all .3s cubic-bezier(0.4, 0, 0.2, 1); 
      font-size:13px; font-weight:600; cursor:pointer; appearance:none; color:var(--text);
      background-image: url("data:image/svg+xml,%3Csvg width='14' height='10' viewBox='0 0 14 10' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L7 8L13 1' stroke='%23f97316' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 42px;
    }
    .csv-selector:focus{border-color:var(--accent); box-shadow:0 0 0 4px rgba(251,146,60,.25), 0 8px 20px rgba(249, 115, 22, 0.2); transform:translateY(-2px)}
    .csv-selector:hover{border-color:#fb923c; box-shadow:0 6px 16px rgba(249, 115, 22, 0.2), inset 0 1px 0 rgba(255,255,255,.8); transform:translateY(-1px)}

    .loading{display:flex; align-items:center; gap:8px; color:var(--muted); padding:10px 0; font-size:12px}
    .dot{width:6px; height:6px; border-radius:50%; background:#f59e0b; animation:bounce 1s infinite alternate}
    .dot:nth-child(2){animation-delay:.15s}
    .dot:nth-child(3){animation-delay:.3s}
    @keyframes bounce{to{transform:translateY(-5px); opacity:.7}}

    .fallback{display:none; gap:8px; align-items:center}
    .fallback button{border:none; background:#111827; color:#fff; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; font-size:12px; transition:all .2s}
    .fallback button:hover{background:#1f2937; transform:translateY(-1px); box-shadow:0 4px 12px rgba(0,0,0,.2)}
    .fallback button:active{transform:translateY(0)}
    .fallback .msg{color:#ef4444; font-size:11px}

    /* Chart & legend styles */
    .chart-card{background:var(--card); border-radius:var(--radius-sm); box-shadow:var(--shadow); overflow:hidden; margin:14px 0}
    .chart-head{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid #f3f4f6}
    .chart-title{font-weight:700; font-size:14px}
    .seg{display:flex; gap:4px}
    .seg-btn{border:none; background:#fff; padding:5px 10px; border-radius:999px; box-shadow:var(--shadow); cursor:pointer; font-weight:600; font-size:11px; transition:all .2s}
    .seg-btn:hover{background:#fff7ed; transform:translateY(-1px)}
    .seg-btn:active{transform:translateY(0)}
    .seg-btn.active{background:#ffedd5; box-shadow:0 0 0 2px #fb923c}
    .chart{padding:12px 14px 8px}
    .chart-row{display:flex; align-items:center; gap:10px; padding:8px 0; transition:all .2s; border-radius:6px; margin:0 -6px; padding-left:6px; padding-right:6px}
    .chart-row:hover{transform:translateX(3px); background:#fafafa}
    .chart-label{width:140px; font-weight:600; font-size:11px; color:#374151; display:flex; align-items:center; gap:6px}
    .chart-label-icon{width:10px; height:10px; border-radius:50%; display:inline-block; box-shadow:0 1px 2px rgba(0,0,0,.15)}
    .chart-label-icon.lvl-1{background:linear-gradient(135deg, #9ca3af, #6b7280)}
    .chart-label-icon.lvl-2{background:linear-gradient(135deg, #60a5fa, #3b82f6)}
    .chart-label-icon.lvl-3{background:linear-gradient(135deg, #a78bfa, #8b5cf6)}
    .chart-label-icon.lvl-4{background:linear-gradient(135deg, #f59e0b, #d97706)}
    .chart-label-icon.lvl-5{background:linear-gradient(135deg, #f87171, #ef4444)}
    .chart-label-icon.lvl-6{background:linear-gradient(135deg, #fbbf24, #f59e0b)}
    .bar-wrap{flex:1; height:18px; background:#f3f4f6; border-radius:9px; position:relative; overflow:hidden; box-shadow:inset 0 1px 2px rgba(0,0,0,.05)}
    .bar{height:100%; border-radius:9px; transition:width .8s cubic-bezier(0.4, 0, 0.2, 1); position:relative; box-shadow:inset 0 1px 0 rgba(255,255,255,.3)}
    .bar::after{content:''; position:absolute; top:0; left:0; right:0; bottom:0; background:linear-gradient(90deg, transparent, rgba(255,255,255,.2), transparent); animation:shimmer 2s infinite}
    @keyframes shimmer{0%,100%{transform:translateX(-100%)} 50%{transform:translateX(100%)}}
    .bar.lvl-1{background:linear-gradient(135deg, #9ca3af, #6b7280)}
    .bar.lvl-2{background:linear-gradient(135deg, #60a5fa, #3b82f6)}
    .bar.lvl-3{background:linear-gradient(135deg, #a78bfa, #8b5cf6)}
    .bar.lvl-4{background:linear-gradient(135deg, #f59e0b, #d97706)}
    .bar.lvl-5{background:linear-gradient(135deg, #f87171, #ef4444)}
    .bar.lvl-6{background:linear-gradient(135deg, #fbbf24, #f59e0b)}
    .bar-count{min-width:90px; text-align:right; font-variant-numeric:tabular-nums; font-size:12px; font-weight:700; color:#111827; display:flex; justify-content:flex-end; align-items:baseline}
    .bar-pct{font-size:10px; color:#6b7280; font-weight:500; margin-left:3px}
    .chart-foot{padding:8px 14px; color:#6b7280; font-size:10px; background:#fafafa; border-top:1px solid #f3f4f6}

    .legend{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:6px 14px; padding:10px 14px; background:#fafafa; border-top:1px solid #f3f4f6}
    .legend-item{display:flex; align-items:center; gap:7px; font-size:10px; color:#374151; padding:4px 6px; border-radius:6px; transition:background .2s}
    .legend-item:hover{background:#fff}
    .legend-dot{width:10px; height:10px; border-radius:50%; display:inline-block; box-shadow:0 1px 2px rgba(0,0,0,.15)}
    /* color the legend dots */
    .legend-dot.lvl-1{background:linear-gradient(135deg, #9ca3af, #6b7280)}
    .legend-dot.lvl-2{background:linear-gradient(135deg, #60a5fa, #3b82f6)}
    .legend-dot.lvl-3{background:linear-gradient(135deg, #a78bfa, #8b5cf6)}
    .legend-dot.lvl-4{background:linear-gradient(135deg, #f59e0b, #d97706)}
    .legend-dot.lvl-5{background:linear-gradient(135deg, #f87171, #ef4444)}
    .legend-dot.lvl-6{background:linear-gradient(135deg, #fbbf24, #f59e0b)}

    footer{text-align:center; padding:20px 0; margin-top:20px}
    footer p{font-size:12px; color:var(--muted); margin:0}
    footer a{color:var(--accent); text-decoration:none; font-weight:600; transition:color .2s}
    footer a:hover{color:#ea580c; text-decoration:underline}

    /* Responsive */
    @media (max-width: 820px){
      .stats{grid-template-columns:1fr}
      .lb-head{flex-direction:column; align-items:flex-start; gap:10px}
      .search-wrap{max-width:100%}
      .legend{grid-template-columns:1fr}
      .chart-label{width:120px}
      .selector-wrap{flex-direction:column; align-items:flex-start; gap:8px}
      .csv-selector{max-width:100%}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="gensynai_logo.jpg" alt="GenSyn AI" class="logo">
      <div>
        <div class="title">GenSyn AI Leaderboard</div>
        <div class="sub">Top Discord contributors by message count ‚Ä¢ Snapshot: Nov 6, 2025</div>
      </div>
    </header>

    <div class="selector-wrap">
      <span class="selector-label">Select Channel/Country:</span>
      <select id="csvSelector" class="csv-selector" aria-label="Select CSV data source">
        <option value="usernames-with-total-message-counts.csv">üí¨ General Chat</option>
        <option value="india_message_counts.csv">üáÆüá≥ India</option>
        <option value="china_message_counts.csv">üá®üá≥ China</option>
        <option value="indonesia_message_counts.csv">üáÆüá© Indonesia</option>
        <option value="russia_message_counts.csv">üá∑üá∫ Russia</option>
        <option value="ukraine_message_counts.csv">üá∫üá¶ Ukraine</option>
        <option value="vietnam_message_counts.csv">üáªüá≥ Vietnam</option>
        <option value="korea_message_counts.csv">üá∞üá∑ Korea</option>
        <option value="turkey_message_counts.csv">üáπüá∑ Turkey</option>
        <option value="nigeria_message_counts.csv">üá≥üá¨ Nigeria</option>
        <option value="blockassist_support_message_counts.csv">ü§ñ BlockAssist Support</option>
        <option value="codeassist_support_message_counts.csv">üíæ CodeAssist Support</option>
        <option value="rlswarm_support.csv">üêù RLSwarm Support</option>
      </select>
    </div>

    <section class="stats">
      <div class="card stat">
        <div class="label">Total Users (All)</div>
        <div class="value" id="statUsers">‚Äî</div>
      </div>
      <div class="card stat">
        <div class="label">Total Messages (All)</div>
        <div class="value" id="statMessages">‚Äî</div>
      </div>
      <div class="card stat">
        <div class="label">Top Score</div>
        <div class="value" id="statTop">‚Äî</div>
      </div>
    </section>

    <!-- Level Distribution Chart -->
    <section class="chart-card" aria-labelledby="chartTitle">
      <div class="chart-head">
        <div class="chart-title" id="chartTitle">Level Distribution</div>
        <div class="seg" role="tablist" aria-label="Chart scope">
          <button class="seg-btn active" data-scope="all" role="tab" aria-selected="true">All Users</button>
          <button class="seg-btn" data-scope="top100" role="tab" aria-selected="false">Top 100</button>
        </div>
      </div>
      <div id="chart" class="chart" aria-live="polite"></div>
      <div class="legend" id="levelLegend" aria-describedby="chartTitle"></div>
      <div class="chart-foot" id="chartFoot"></div>
    </section>

    <section class="leaderboard">
      <div class="lb-card">
        <div class="lb-head">
          <div class="lb-title">Main Leaderboard</div>
          <div class="search-wrap" role="search">
            <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.35-4.35m1.35-5.65a7 7 0 11-14 0 7 7 0 0114 0z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
            <input id="search" class="search-input" placeholder="Search for your username..." autocomplete="off" aria-label="Search usernames" />
            <button id="clearSearch" class="clear-btn" aria-label="Clear search" tabindex="-1">Clear</button>
          </div>
        </div>
        <div class="helper" id="helperText">Showing top 100 users ‚Ä¢ 10 per page</div>
        <div class="table-wrap">
          <table aria-label="Leaderboard">
            <thead>
              <tr>
                <th style="width:110px">Rank</th>
                <th>Username</th>
                <th style="width:180px">Message Count</th>
                <th style="width:160px">Level Badge</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td colspan="4"><div class="loading"><span class="dot"></span><span class="dot"></span><span class="dot"></span> Loading CSV‚Ä¶</div></td></tr>
            </tbody>
          </table>
        </div>
        <div class="pagination" id="pagination" aria-label="Pagination"></div>
      </div>

      <div class="fallback" id="fallback">
        <span class="msg">Couldn't auto-load the selected CSV file. You can load it manually:</span>
        <button id="pickFile">Choose CSV</button>
        <input id="fileInput" type="file" accept=".csv" hidden />
      </div>
    </section>
  </div>

  <script>
    const state = {
      usersAll: [],
      usersTop100: [],
      currentPage: 1,
      rowsPerPage: 10,
      searchActive: false,
      searchQuery: '',
      chartScope: 'all',
    };

    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);

    const tbody = $('#tbody');
    const pagination = $('#pagination');
    const helperText = $('#helperText');
    const statUsers = $('#statUsers');
    const statMessages = $('#statMessages');
    const statTop = $('#statTop');
    const searchInput = $('#search');
    const clearBtn = $('#clearSearch');
    const fallback = $('#fallback');
    const fileInput = $('#fileInput');
    const pickFileBtn = $('#pickFile');
    const chartEl = $('#chart');
    const chartFoot = $('#chartFoot');
    const legendEl = $('#levelLegend');
    const csvSelector = $('#csvSelector');

    // Canonical level meta (used for labels/legend)
    const LEVELS_META = [
      { lvl:1, cls:'lvl-1', name:'Level 1', range:'0‚Äì100' },
      { lvl:2, cls:'lvl-2', name:'Level 2', range:'101‚Äì500' },
      { lvl:3, cls:'lvl-3', name:'Level 3', range:'501‚Äì1,000' },
      { lvl:4, cls:'lvl-4', name:'Level 4', range:'1,001‚Äì5,000' },
      { lvl:5, cls:'lvl-5', name:'Level 5', range:'5,001‚Äì9,999' },
      { lvl:6, cls:'lvl-6', name:'Level 6', range:'10,000+' },
    ];

    function formatNumber(n){
      return new Intl.NumberFormat(undefined).format(n);
    }

    function getLevel(count){
      if (count >= 10000) return { lvl: 6, cls: 'lvl-6', name: 'Level 6' };
      if (count >= 5001) return { lvl: 5, cls: 'lvl-5', name: 'Level 5' };
      if (count >= 1001) return { lvl: 4, cls: 'lvl-4', name: 'Level 4' };
      if (count >= 501)  return { lvl: 3, cls: 'lvl-3', name: 'Level 3' };
      if (count >= 101)  return { lvl: 2, cls: 'lvl-2', name: 'Level 2' };
      return { lvl: 1, cls: 'lvl-1', name: 'Level 1' };
    }

    // FIX: ensure no stray parenthesis here
    function escapeHTML(str){
      return String(str).replace(/[&<>"']/g, (s) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        "\"": "&quot;",
        "'": "&#39;"
      })[s]);
    }

    function highlight(text, query){
      if (!query) return escapeHTML(text);
      const safe = escapeHTML(text);
      const q = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      return safe.replace(new RegExp(q, 'gi'), m => `<mark>${m}</mark>`);
    }

    function rankBadge(rank){
      let cls = 'rank-badge';
      if (rank === 1) cls += ' gold';
      else if (rank === 2) cls += ' silver';
      else if (rank === 3) cls += ' bronze';
      return `<span class="${cls}" aria-label="Rank ${rank}">${rank}</span>`;
    }

    function animateValue(el, end){
      const start = 0;
      const duration = 1000;
      const startTime = performance.now();
      const animate = (currentTime) => {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const easeOut = 1 - Math.pow(1 - progress, 3);
        const current = Math.floor(start + (end - start) * easeOut);
        el.textContent = formatNumber(current);
        if (progress < 1) requestAnimationFrame(animate);
      };
      requestAnimationFrame(animate);
    }

    function renderStats(){
      const all = state.usersAll;
      const totalUsers = all.length;
      const totalMessages = all.reduce((s,u)=> s + u.message_count, 0);
      const topScore = all[0] ? all[0].message_count : 0;
      animateValue(statUsers, totalUsers);
      animateValue(statMessages, totalMessages);
      animateValue(statTop, topScore);
    }

    function renderTable(rows){
      if (!rows.length){
        tbody.innerHTML = `<tr><td colspan="4"><div class="not-found">Not found</div></td></tr>`;
        return;
      }
      const html = rows.map(user => {
        const level = getLevel(user.message_count);
        const rangeText = LEVELS_META[level.lvl-1].range;
        return `<tr>
          <td>${rankBadge(user.rank)}</td>
          <td><span class="uname">${state.searchActive ? highlight(user.username, state.searchQuery) : escapeHTML(user.username)}</span></td>
          <td><strong>${formatNumber(user.message_count)}</strong></td>
          <td><span class="level ${level.cls}" title="${level.name}: ${rangeText} messages">${level.name}</span></td>
        </tr>`;
      }).join('');
      tbody.innerHTML = html;
    }

    function renderPagination(){
      if (state.searchActive){
        pagination.innerHTML = '';
        return;
      }
      const total = state.usersTop100.length;
      const pages = Math.max(1, Math.ceil(total / state.rowsPerPage));
      const parts = [];
      const btn = (label, opts={}) => {
        const disabled = opts.disabled ? 'disabled' : '';
        const active = opts.active ? 'active' : '';
        return `<button class="page-btn ${active}" ${disabled} data-page="${opts.page ?? ''}">${label}</button>`;
      };
      parts.push(btn('Prev', { disabled: state.currentPage === 1, page: state.currentPage - 1 }));
      for (let p=1; p<=pages; p++) parts.push(btn(p, { page: p, active: p === state.currentPage }));
      parts.push(btn('Next', { disabled: state.currentPage === pages, page: state.currentPage + 1 }));
      pagination.innerHTML = parts.join('');

      pagination.querySelectorAll('.page-btn').forEach(el => {
        const page = Number(el.dataset.page);
        el.addEventListener('click', () => {
          if (!page || el.hasAttribute('disabled')) return;
          state.currentPage = page;
          updateView();
        });
      });
    }

    function updateView(){
      if (state.searchActive){
        const q = state.searchQuery.trim().toLowerCase();
        const results = state.usersAll.filter(u => u.username.toLowerCase().includes(q));
        helperText.textContent = results.length ? `Search results for "${state.searchQuery}" ‚Ä¢ ${results.length} match${results.length!==1?'es':''}` : `No matches for "${state.searchQuery}"`;
        renderTable(results.slice(0, 100)); // Limit search results to 100
        renderPagination();
      } else {
        helperText.textContent = 'Showing top 100 users ‚Ä¢ 10 per page';
        const start = (state.currentPage - 1) * state.rowsPerPage;
        const pageRows = state.usersTop100.slice(start, start + state.rowsPerPage);
        renderTable(pageRows);
        renderPagination();
      }
    }

    function normalizeRow(row){
      const username = row.username ?? row.User ?? row.Username ?? row["user name"] ?? row["User Name"]; 
      const mcRaw = row.message_count ?? row["message_count"] ?? row["Message Count"] ?? row["messages"] ?? row["total_messages"]; 
      const message_count = Number(String(mcRaw ?? '').replace(/[\,\s]/g, ''));
      if (!username || !Number.isFinite(message_count)) return null;
      return { username: String(username).trim(), message_count };
    }

    function ingestData(rows){
      const users = rows.map(normalizeRow).filter(Boolean);
      users.sort((a,b)=> b.message_count - a.message_count || a.username.localeCompare(b.username));
      users.forEach((u,i)=> u.rank = i + 1);
      state.usersAll = users;
      state.usersTop100 = users.slice(0, 100);
      state.currentPage = 1; state.searchActive = false; state.searchQuery = '';
      renderStats();
      updateView();
      renderLevelChart(state.chartScope);
    }

    function loadCSVFromURL(filename = 'usernames-with-total-message-counts.csv'){
      return new Promise((resolve, reject) => {
        Papa.parse(filename, {
          download: true,
          header: true,
          skipEmptyLines: true,
          complete: (results) => {
            if (results && results.data && results.data.length){ resolve(results.data); }
            else reject(new Error('CSV parsed but empty'));
          },
          error: (err) => reject(err)
        });
      });
    }

    async function loadSelectedCSV(){
      const selectedFile = csvSelector.value;
      tbody.innerHTML = '<tr><td colspan="4"><div class="loading"><span class="dot"></span><span class="dot"></span><span class="dot"></span> Loading CSV‚Ä¶</div></td></tr>';
      fallback.style.display = 'none';
      
      // Disable selector while loading to prevent multiple loads
      csvSelector.disabled = true;
      
      try {
        const rows = await loadCSVFromURL(selectedFile);
        ingestData(rows);
      } catch (e){
        console.error('Error loading CSV:', e);
        tbody.innerHTML = `<tr><td colspan="4"><div class="not-found">Couldn't load ${selectedFile}. Make sure the file exists.</div></td></tr>`;
        showFallback();
      } finally {
        csvSelector.disabled = false;
      }
    }

    function showFallback(){
      fallback.style.display = 'flex';
    }

    function debounce(fn, ms){
      let t; return (...args) => { clearTimeout(t); t = setTimeout(()=>fn.apply(null,args), ms); };
    }

    // ===== Chart & legend logic =====
    function computeLevelBuckets(list){
      const buckets = [0,0,0,0,0,0]; // index 0->L1 ‚Ä¶ 5->L6
      for (const u of list){
        const lvl = getLevel(u.message_count).lvl; // 1..6
        buckets[lvl-1]++;
      }
      return buckets;
    }

    function renderLegend(){
      const items = LEVELS_META.map(m => (
        `<div class="legend-item"><span class="legend-dot ${m.cls}"></span><span>${m.name} ‚Äî ${m.range} messages</span></div>`
      )).join('');
      legendEl.innerHTML = items;
    }

    function renderLevelChart(scope='all'){
      const list = scope === 'top100' ? state.usersTop100 : state.usersAll;
      const buckets = computeLevelBuckets(list);
      const total = list.length;
      const MIN_BAR_PCT = 0.5; // visual floor so tiny non-zero buckets still show color
      const labels = LEVELS_META.map(m => `${m.name} (${m.range})`);
      const rows = buckets.map((count, idx) => {
        const userPctRaw = total > 0 ? (count / total) * 100 : 0;
        const userPct = userPctRaw < 0.1 && userPctRaw > 0 ? userPctRaw.toFixed(4) : userPctRaw.toFixed(1);
        const pct = count > 0 ? Math.max(userPctRaw, MIN_BAR_PCT) : 0; // Use actual percentage for bar width
        const cls = `lvl-${idx+1}`;
        const meta = LEVELS_META[idx];
        const aria = `${labels[idx]}: ${formatNumber(count)} users (${userPct}%)`;
        return `<div class="chart-row">
          <div class="chart-label">
            <span class="chart-label-icon ${meta.cls}"></span>
            <span>${meta.name}</span>
          </div>
          <div class="bar-wrap" aria-hidden="true" title="${labels[idx]}: ${formatNumber(count)} users">
            <div class="bar ${cls}" style="width:${pct}%"></div>
          </div>
          <div class="bar-count" aria-label="${aria}">
            ${formatNumber(count)}
            <span class="bar-pct">(${userPct}%)</span>
          </div>
        </div>`;
      }).join('');
      chartEl.innerHTML = rows;
      chartFoot.innerHTML = `<strong>${scope==='top100' ? 'Top 100' : 'All users'}</strong> ‚Ä¢ ${formatNumber(list.length)} total users`;
      $$('.seg-btn').forEach(btn => {
        const active = btn.dataset.scope === scope;
        btn.classList.toggle('active', active);
        btn.setAttribute('aria-selected', String(active));
      });
    }

    // ==== Lightweight Test Harness (runs in console) ====
    function runTests(){
      const results = [];
      const assert = (name, cond) => { results.push({ name, pass: !!cond }); if(!cond) console.error(`‚ùå ${name}`); };
      const eq = (a,b) => a===b;

      // escapeHTML tests
      assert('escapeHTML encodes &', eq(escapeHTML('&'), '&amp;'));
      assert('escapeHTML encodes <', eq(escapeHTML('<'), '&lt;'));
      assert('escapeHTML encodes >', eq(escapeHTML('>'), '&gt;'));
      assert('escapeHTML encodes "', eq(escapeHTML('"'), '&quot;'));
      assert("escapeHTML encodes '", eq(escapeHTML("'"), '&#39;'));
      assert('escapeHTML mixed', eq(escapeHTML('A&B<C>"\''), 'A&amp;B&lt;C&gt;&quot;&#39;'));

      // getLevel boundary tests
      const L = (n)=>getLevel(n).lvl;
      assert('Level 1 at 0', eq(L(0),1));
      assert('Level 1 at 100', eq(L(100),1));
      assert('Level 2 at 101', eq(L(101),2));
      assert('Level 2 at 500', eq(L(500),2));
      assert('Level 3 at 501', eq(L(501),3));
      assert('Level 3 at 1000', eq(L(1000),3));
      assert('Level 4 at 1001', eq(L(1001),4));
      assert('Level 4 at 5000', eq(L(5000),4));
      assert('Level 5 at 5001', eq(L(5001),5));
      assert('Level 5 at 9999', eq(L(9999),5));
      assert('Level 6 at 10000', eq(L(10000),6));
      assert('Level 6 above 10000', eq(L(12000),6));

      // legend/meta tests
      assert('LEVELS_META length 6', LEVELS_META.length===6);
      assert('L5 range 5,001‚Äì9,999', LEVELS_META[4].range==='5,001‚Äì9,999');
      assert('L6 range 10,000+', LEVELS_META[5].range==='10,000+');

      // normalizeRow tests
      const nr = normalizeRow({ username:'alice', message_count:'1,234' });
      assert('normalizeRow parses commas', nr && nr.username==='alice' && nr.message_count===1234);
      const nr2 = normalizeRow({ User:'Bob', messages:'42' });
      assert('normalizeRow header variants', nr2 && nr2.username==='Bob' && nr2.message_count===42);

      // highlight test (regex escaping)
      const h = highlight('user.[name]', '.[');
      assert('highlight escapes regex', h.includes('<mark>'));

      // computeLevelBuckets tests
      const sample = [0,100,101,500,501,1000,1001,5000,5001,9999,10000].map(n=>({username:'u'+n, message_count:n}));
      const b = computeLevelBuckets(sample);
      assert('Buckets length 6', b.length===6);
      assert('Bucket L1 count', b[0]===2);
      assert('Bucket L2 count', b[1]===2);
      assert('Bucket L3 count', b[2]===2);
      assert('Bucket L4 count', b[3]===2);
      assert('Bucket L5 count', b[4]===2);
      assert('Bucket L6 count', b[5]===1);
      assert('Bucket sum equals list length', b.reduce((a,c)=>a+c,0)===sample.length);

      console.log(`\n‚Äî‚Äî Test Summary ‚Äî‚Äî`);
      const passed = results.filter(r=>r.pass).length;
      console.log(`Passed ${passed}/${results.length} checks`);
      window.__leaderboardTests = results;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Load initial CSV
      await loadSelectedCSV();

      renderLegend();

      try { runTests(); } catch (e) { console.warn('Tests failed to run:', e); }

      // Add event listener for CSV selector
      csvSelector.addEventListener('change', loadSelectedCSV);

      const onSearch = debounce(() => {
        const q = searchInput.value || '';
        state.searchQuery = q;
        state.searchActive = q.trim().length > 0;
        clearBtn.style.display = state.searchActive ? 'inline-block' : 'none';
        updateView();
      }, 300);

      searchInput.addEventListener('input', onSearch);
      clearBtn.addEventListener('click', () => { searchInput.value = ''; onSearch(); searchInput.focus(); });

      pickFileBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        Papa.parse(file, {
          header:true,
          skipEmptyLines:true,
          complete: (results) => { ingestData(results.data); fallback.style.display = 'none'; },
          error: () => { alert('Failed to parse the selected CSV.'); }
        });
      });

      searchInput.addEventListener('keydown', (e) => { if (e.key === 'Escape'){ clearBtn.click(); } });

      $$('.seg-btn').forEach(btn => {
        btn.addEventListener('click', () => { state.chartScope = btn.dataset.scope; renderLevelChart(state.chartScope); });
      });
    });
  </script>

  <footer>
    <p>Made by <a href="https://twitter.com/Abbymaxpain" target="_blank" rel="noopener">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:middle; margin-right:4px">
        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
      </svg>
      @Abbymaxpain
    </a></p>
  </footer>
</body>
</html>
